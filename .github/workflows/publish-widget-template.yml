name: Publish Widget

on:
  workflow_call:
    inputs:
      widget-path:
        required: true
        type: string
      version:
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Validate version input
        if: ${{ inputs.version == '' }}
        run: |
          echo "❌ version cannot be empty" >&2
          exit 1

      - name: Bump composer version
        working-directory: ${{ inputs.widget-path }}
        run: composer config version "${{ inputs.version }}"


      - name: Commit version bump
        working-directory: ${{ inputs.widget-path }}
        run: |
          NAME=$(basename "${{ inputs.widget-path }}")
          git add "${{ inputs.widget-path }}/composer.json"
          git commit -am "chore: bump $NAME to v${{ inputs.version }}"

      - name: Create tag
        run: |
          NAME=$(basename "${{ inputs.widget-path }}")
          git tag "$NAME-v${{ inputs.version }}"

      - name: Push to monorepo (no tags)
        run: git push origin HEAD:main --no-tags

      - name: Split subtree
        run: |
          NAME=$(basename "${{ inputs.widget-path }}")
          BR="release/$NAME"
          git subtree split --prefix="${{ inputs.widget-path }}" -b "$BR"

      - name: Push subtree to widget repo
        run: |
          NAME=$(basename "${{ inputs.widget-path }}")
          BR="release/$NAME"
          REPO="https://x-access-token:${{ secrets.WIDGET_REPO_PAT }}@github.com/WeAreHausTech/$NAME.git"
          git push "$REPO" "$BR:main" --tags
